<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>
        
        Nacos2架构设计 |
        
        启航的蜗牛</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- open graph -->
    <meta name="description" content="&gt; https:&#x2F;&#x2F;blog.csdn.net&#x2F;alisystemsoftware&#x2F;article&#x2F;details&#x2F;111934889  Nacos 在阿里巴巴起源于 2008 年五彩石项目，该项目完成了微服务拆分和业务中台建设，随着云计算和开源环境的兴起，2018 年我们深刻感受到开源软件行业的影响，因此决定将 Nacos 开源，输出阿里十年关于服务发现和配管管理的沉淀，推动微服务行业发展，加速">
<meta property="og:type" content="article">
<meta property="og:title" content="Nacos2架构设计">
<meta property="og:url" content="https://www.alicharles.com/article/nacos/nacos-architecture/index.html">
<meta property="og:site_name" content="启航的蜗牛">
<meta property="og:description" content="&gt; https:&#x2F;&#x2F;blog.csdn.net&#x2F;alisystemsoftware&#x2F;article&#x2F;details&#x2F;111934889  Nacos 在阿里巴巴起源于 2008 年五彩石项目，该项目完成了微服务拆分和业务中台建设，随着云计算和开源环境的兴起，2018 年我们深刻感受到开源软件行业的影响，因此决定将 Nacos 开源，输出阿里十年关于服务发现和配管管理的沉淀，推动微服务行业发展，加速">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186852933-dd5d6331-5782-4838-818c-709e076d62fb.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=454&id=ueb87fee0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=908&originWidth=1950&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=506718&status=done&style=none&taskId=uba88d0b8-0039-4e54-8c8a-177738ba7ef&title=&width=975">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186884814-fe768519-de4e-4630-a9e6-0c0cb13c2797.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=462&id=ud918b33a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=924&originWidth=2018&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=267048&status=done&style=none&taskId=u3c384325-8783-4712-ac3d-56cbb32d224&title=&width=1009">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186916107-cbb155cf-e62a-4df0-be16-ca62d32f6c2c.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=448&id=uc689c6cf&margin=%5Bobject%20Object%5D&name=image.png&originHeight=896&originWidth=1822&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=618566&status=done&style=none&taskId=ub3dd0f13-5e44-4423-80d7-1ad53690dd8&title=&width=911">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186965908-53f94599-34de-45bb-a432-56ac7eabf141.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=u115c4e2b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=976&originWidth=1752&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=733696&status=done&style=none&taskId=uada5818f-3c98-4d40-a36a-ed7988fb6eb&title=&width=876">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187004205-6be23bea-d969-4551-8b8f-21ab6748c3cf.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=381&id=uc8f19a83&margin=%5Bobject%20Object%5D&name=image.png&originHeight=762&originWidth=1148&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=543022&status=done&style=none&taskId=u4fca4d8e-a3ca-47ac-baaa-f3a5a387c80&title=&width=574">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187106644-8785b9d8-2b78-4f86-bc27-ba0a88d031e8.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=453&id=ue365d5bc&margin=%5Bobject%20Object%5D&name=image.png&originHeight=906&originWidth=1640&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=727769&status=done&style=none&taskId=ub6aaff50-3f24-4656-b096-ed3ab2a0976&title=&width=820">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187142467-84067a03-cc99-4723-b3e9-bcb0eeadf041.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=441&id=u4ac18cfb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=882&originWidth=1624&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=836035&status=done&style=none&taskId=ud8f7b0c8-426b-49a5-baf8-18fb08b2ccd&title=&width=812">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187199068-efc7d1d5-451c-4d57-9f70-9f5283ac1bcc.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=413&id=uabd7a682&margin=%5Bobject%20Object%5D&name=image.png&originHeight=826&originWidth=1106&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=694419&status=done&style=none&taskId=u86a6c9d4-1942-4731-98e1-9edcd21fbeb&title=&width=553">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187260940-7947ba57-e15b-4bff-b40a-53f5636d684a.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=413&id=ue56cd15f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=826&originWidth=1800&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=490103&status=done&style=none&taskId=u11aa0ade-115c-4b4b-afda-9ff959e6697&title=&width=900">
<meta property="article:published_time" content="2021-03-31T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-15T04:19:28.000Z">
<meta property="article:author" content="charles">
<meta property="article:tag" content="Nacos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186852933-dd5d6331-5782-4838-818c-709e076d62fb.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=454&id=ueb87fee0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=908&originWidth=1950&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=506718&status=done&style=none&taskId=uba88d0b8-0039-4e54-8c8a-177738ba7ef&title=&width=975">

    <link rel="icon" sizes="any" mask href="//cdn.alicharles.com/static/images/logo.svg">
    <link rel="stylesheet" href="//cdn.alicharles.com/static/css/bootstrap.css">  
    <link rel="stylesheet" href="//cdn.alicharles.com/static/css/style.css">   
    <link rel="stylesheet" href="//cdn.alicharles.com/static/lib/fontawesome/css/all.css">   
    <link rel="stylesheet" href="//cdn.alicharles.com/static/lib/prism/css/prism.css">   
    
    

<meta name="generator" content="Hexo 6.2.0"></head>


<body>

  <!-- Nav -->
  <header>
    <nav class="navbar navbar-expand-md navbar-light charles-navbar py-0">
        <div class="container">
            <a class="navbar-brand mr-0 mr-md-2" href="/">
                <img src="//cdn.alicharles.com/static/images/charles-logo.png" height="32px" width="80px" alt="charles">
            </a>
            <button class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarDropdown">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarDropdown">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">主页<span class="sr-only">(current)</span></a>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" target="_blank">
                            推荐
                        </a>
                        <div class="dropdown-menu dropdown-menu-right mt-0" >
                            <div class="row mx-0" style="width: 16rem">
                                
                                
                                    
                                    
                                    <div class="col-sm " style="overflow: hidden;">
                                        
                                            <a class="nav-link" href="/categories/jvm/" target="_blank">JVM</a>
                                        
                                            <a class="nav-link" href="/categories/design-pattern/" target="_blank">设计模式</a>
                                        
                                            <a class="nav-link" href="/tags/Lock/" target="_blank">Java锁</a>
                                        
                                    </div>
                                    
                                    
                                
                                    
                                    
                                    <div class="col-sm  border-left " style="overflow: hidden;">
                                        
                                            <a class="nav-link" href="/categories/disruptor/" target="_blank">Disruptor</a>
                                        
                                            <a class="nav-link" href="/categories/netty/" target="_blank">Netty</a>
                                        
                                            <a class="nav-link" href="/categories/ddd/" target="_blank">领域驱动设计</a>
                                        
                                    </div>
                                    
                                    
                                
                            </div>
                        </div>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link" href="/categories" target="_blank">分类</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tags" target="_blank">标签</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/archives" target="_blank">归档</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/about" target="_blank">关于</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/search" target="_blank">搜索</a>
                    </li>
                </ul>
            </div>
        </div> <!-- /container -->
    </nav>
</header>


  <!-- Main Content -->
  <div class="container bg-white my-3">
    <div class="post-article">
        <section id="posts" class="posts-expand">
            <h1>Nacos2架构设计</h1>
<header class="post-header">
     <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="fa far fa-user"></i>
        </span>
        <span class="post-meta-item-text">发表于</span>
        <time itemprop="dateCreated" datetime="2021-04-01T00:00:00+08:00">
            2021-04-01
        </time>
    </span>
    <span class="post-category">
        
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="fa far fa-calendar-alt"></i>
        </span>
        <span class="post-meta-item-text">分类于</span>
        
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
            <a href="/categories/nacos/" itemprop="url" rel="index">
              <span itemprop="name">nacos</span>
            </a>
        </span>
        
    
    </span>
</header>
<div class="post-body">
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/alisystemsoftware/article/details/111934889">https://blog.csdn.net/alisystemsoftware/article/details/111934889</a></p>
</blockquote>
<p>Nacos 在阿里巴巴起源于 2008 年五彩石项目，该项目完成了微服务拆分和业务中台建设，随着云计算和开源环境的兴起，2018 年我们深刻感受到开源软件行业的影响，因此决定将 Nacos 开源，输出阿里十年关于服务发现和配管管理的沉淀，推动微服务行业发展，加速企业数字化转型。<br>目前 Nacos 支持主流微服务开发语言 &amp; 主流服务框架和配置管理框架，比如支持 Duboo 和 SCA， 还对接了一些云原生的组件比如 coreDNS 和 sentinel 等。<br>客户端语言方面支持诸如 Java、go python 等主流语言，还有近期刚发布正式版本的 C# 和 C++，在此感谢所有社区贡献者的支持。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186852933-dd5d6331-5782-4838-818c-709e076d62fb.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=454&id=ueb87fee0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=908&originWidth=1950&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=506718&status=done&style=none&taskId=uba88d0b8-0039-4e54-8c8a-177738ba7ef&title=&width=975" alt="image.png" width="975"><br>Nacos 开源 2 年多以来，共发布了 34 个版本，其中有一些比较重要的里程碑版本；Nacos 还非常年轻，有很大的进步空间，欢迎社区及各界大佬一起共同建设。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186884814-fe768519-de4e-4630-a9e6-0c0cb13c2797.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=462&id=ud918b33a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=924&originWidth=2018&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=267048&status=done&style=none&taskId=u3c384325-8783-4712-ac3d-56cbb32d224&title=&width=1009" alt="image.png" width="1009"></p>
<h2 id="Nacos-1-X-架构及问题"><a href="#Nacos-1-X-架构及问题" class="headerlink" title="Nacos 1.X 架构及问题"></a>Nacos 1.X 架构及问题</h2><p>接下来我们看一下 nacos1.x 架构及其分析一下存在的比较重要的问题。首先来看一下架构简图。</p>
<h3 id="Nacos-1-X-架构层次"><a href="#Nacos-1-X-架构层次" class="headerlink" title="Nacos 1.X 架构层次"></a>Nacos 1.X 架构层次</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186916107-cbb155cf-e62a-4df0-be16-ca62d32f6c2c.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=448&id=uc689c6cf&margin=%5Bobject%20Object%5D&name=image.png&originHeight=896&originWidth=1822&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=618566&status=done&style=none&taskId=ub3dd0f13-5e44-4423-80d7-1ad53690dd8&title=&width=911" alt="image.png" width="911">Nacos 1.X 大致分为 5 层， 分别是接入、通信、功能、同步和持久化。<br>接入层是用户最直接交互的层面，主要有 Nacos 客户端，以及依赖客户端的 Dubbo 和 SCA 以及用户操作的控制台 Console 组成。客户端和 Console 进行服务和配置操作，统一通过 HTTP 的 OpenAPI 发起通信请求。<br>通信层主要基于 HTTP 的短连接请求模型进行，部分推送功能通过 UDP 进行通信。<br>功能目前有服务发现和配置管理，这层也就是实际管理服务和配置的业务层。<br>同步层有数据同步的 AP 模式 Distro 和 CP 模式 Raft，还有有一个最简易的水平通知 Notify，用处各不相同：</p>
<ul>
<li>Distro：非持久化服务的同步模式。</li>
<li>Raft：持久化服务的同步模式、以及使用 Derby 作为配置的存储时同步配置操作。</li>
<li>Notify：使用 MySQL 作为配置的存储时，通知其他节点更新缓存及发起配置推送。</li>
</ul>
<p>持久化层 Nacos 使用 MySQL、Derby 和本地文件系统来进行数据的持久化 配置信息，用户信息，权限信息存储在 MySQL 或 Derby 数据库中， 持久化服务信息及服务和实例元数据信息存储在本地文件系统。</p>
<h3 id="Nacos-1-X-架构下的服务模型"><a href="#Nacos-1-X-架构下的服务模型" class="headerlink" title="Nacos 1.X 架构下的服务模型"></a>Nacos 1.X 架构下的服务模型</h3><p>我们通过一个服务发现的流程，再深入熟悉一下 Nacos 1.X 架构和基于当前架构的 Nacos 服务发现模型。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647186965908-53f94599-34de-45bb-a432-56ac7eabf141.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=488&id=u115c4e2b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=976&originWidth=1752&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=733696&status=done&style=none&taskId=uada5818f-3c98-4d40-a36a-ed7988fb6eb&title=&width=876" alt="image.png" width="876"></p>
<p>Nacos 客户端注册服务会通过 OpenAPI 发送 Http 注册服务的请求，请求内容会带上服务信息及实例信息，通常这个步骤是由微服务框架 SCA 和 dubbo 完成。<br>服务端收到请求后，会先在 Contoller 中进行数据的读取和校验，比如 IP 是否合法，服务名是否正确等等。校验通过后，如果这个服务是第一次注册，Nacos 会在服务端生成一个 Service 对象，然后把这次注册的实例信息存入这个 Service 对象中；如果 Nacos 服务端已经有了这个 Service 对象，那么就会直接把新注册的实例信息存入对象。这个 Service 对象通过 命名空间+Group+Service 的组合来保证唯一性。<br>完成实例存入 Service 的同时，会触发两个事件，其中一个事件是用于数据同步的，Nacos 服务端会根据这个服务是否是临时对象的信息，使用 Distro 或者 Raft 协议进行同步，通知其他的 Nacos 节点该服务发生了变更；另一个事件则通知在该 Nacos 服务节点上订阅了该服务的订阅者，并根据订阅者信息，通过 UDP 的方式，把最新的服务列表推送到订阅者客户端上。这就完成了一次服务注册流程。<br>另外，对于那些被定义为持久化的服务的所有信息，都会通过 raft 协议，保证能够写入到文件系统中被持久化。<br>最后，其他的 Nacos 节点，在通过同步而进行 Service 变更的时候也会触发通知订阅者的事件，从而使在其他 Nacos 服务节点上订阅该服务的订阅者也能收到推送。</p>
<h3 id="1-X-架构存在的问题"><a href="#1-X-架构存在的问题" class="headerlink" title="1.X 架构存在的问题"></a>1.X 架构存在的问题</h3><p>粗略介绍了下 Nacos1.X 的架构和服务发现模型，接下来分析一下 Nacos1.X 架构所面临的几个比较重要的问题。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187004205-6be23bea-d969-4551-8b8f-21ab6748c3cf.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=381&id=uc8f19a83&margin=%5Bobject%20Object%5D&name=image.png&originHeight=762&originWidth=1148&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=543022&status=done&style=none&taskId=u4fca4d8e-a3ca-47ac-baaa-f3a5a387c80&title=&width=574" alt="image.png" width="574"><br>一句话总结，心跳多，无效查询多，心跳续约感知变化慢，连接消耗大，资源空耗严重。</p>
<ul>
<li><p>心跳数量多，导致 TPS 居高不下</p>
<blockquote>
<p>通过心跳续约，当服务规模上升时，特别是类似 Dubbo 的接口级服务较多时，心跳及配置元数据的轮询数量众多，导致集群 TPS 很高，系统资源高度空耗。</p>
</blockquote>
</li>
<li><p>通过心跳续约感知服务变化，时延长</p>
<blockquote>
<p>心跳续约需要达到超时时间才会移除并通知订阅者，默认为 15s，时延较长，时效性差。若改短超时时间，当网络抖动时，会频繁触发变更推送，对客户端服务端都有更大损耗。</p>
</blockquote>
</li>
<li><p>UDP 推送不可靠，导致 QPS 居高不下</p>
<blockquote>
<p>由于 UDP 不可靠，因此客户端测需要每隔一段时间进行对账查询，保证客户端缓存的服务列表的状态正确，当订阅客户端规模上升时，集群 QPS 很高，但大多数服务列表其实不会频繁改变，造成无效查询，从而存在资源空耗。</p>
</blockquote>
</li>
<li><p>基于 HTTP 短连接模型，TIME_WAIT 状态连接过多</p>
<blockquote>
<p>HTTP 短连接模型，每次客户端请求都会创建和销毁 TCP 链接，TCP 协议销毁的链接状态是 WAIT_TIME，完全释放还需要一定时间，当 TPS 和 QPS 较高时，服务端和客户端可能有大量的 WAIT_TIME 状态链接，从而会导致 connect time out 错误或者 Cannot assign requested address 的问题。</p>
</blockquote>
</li>
<li><p>配置模块的 30 秒长轮询引起的频繁 GC</p>
<blockquote>
<p>配置模块使用 HTTP 短连接阻塞模型来模拟长连接通信，但是由于并非真实的长连接模型，因此每 30 秒需要进行一次请求和数据的上下文切换，每一次切换都有引起造成一次内存浪费，从而导致服务端频繁 GC。</p>
</blockquote>
</li>
</ul>
<h2 id="Nacos-2-0-架构及新模型"><a href="#Nacos-2-0-架构及新模型" class="headerlink" title="Nacos 2.0 架构及新模型"></a>Nacos 2.0 架构及新模型</h2><h3 id="Nacos-2-0-架构层次"><a href="#Nacos-2-0-架构层次" class="headerlink" title="Nacos 2.0 架构层次"></a>Nacos 2.0 架构层次</h3><p>Nacos 2.X 在 1.X 的架构基础上 新增了对长连接模型的支持，同时保留对旧客户端和 openAPI 的核心功能支持。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187106644-8785b9d8-2b78-4f86-bc27-ba0a88d031e8.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=453&id=ue365d5bc&margin=%5Bobject%20Object%5D&name=image.png&originHeight=906&originWidth=1640&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=727769&status=done&style=none&taskId=ub6aaff50-3f24-4656-b096-ed3ab2a0976&title=&width=820" alt="image.png" width="820"><br>通信层目前通过 gRPC 和 Rsocket 实现了长连接 RPC 调用和推送能力。<br>在服务端测，新增一个链接层，用来将不同类型的 Request 请求，将来自不同客户端的不同类型请求，转化为相同语意的功能数据结构，复用业务处理逻辑。同时，将来的流量控制和负载均衡等功能也会在链接层处理。<br>其他架构分层在大体上保持不变。</p>
<h3 id="Nacos-2-0-新服务模型"><a href="#Nacos-2-0-新服务模型" class="headerlink" title="Nacos 2.0 新服务模型"></a>Nacos 2.0 新服务模型</h3><p>虽然 Nacos2.0 的在架构层次上并未做太大的变化，但是具体的模型细节却有不小的改动，依旧使用注册服务的流程，再深入了解一下 Nacos2.0 服务模型的变化。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187142467-84067a03-cc99-4723-b3e9-bcb0eeadf041.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=441&id=u4ac18cfb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=882&originWidth=1624&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=836035&status=done&style=none&taskId=ud8f7b0c8-426b-49a5-baf8-18fb08b2ccd&title=&width=812" alt="image.png" width="812"><br>由于通信使用了 RPC 方式，因此某一客户端的所有请求（无论是注册还是订阅）都通过同一个链接和同一个服务节点进行，不像之前通过 HTTP 连接可能每次请求都请求在不同的 Nacos 节点上，这就导致了服务发现的数据内容由原来的无状态化变为了与连接状态绑定的一种有状态数据。为了适应这种变化，需要改变一下数据模型，因此抽象了一个新数据结构，将同一个客户端通过该链接发布和订阅的内容关联起来，暂命名为 Client。这个 Client 不是客户端的意思，而是这个客户端所相关的数据内容，一个链接与一个 Client 对应。<br>当客户端发布了服务时，该客户端所发布的所有服务与订阅者信息会被更新到与该客户端链接相对应的 Client 对象中，然后通过事件机制触发对索引信息的更新。这个索引信息是客户端链接和服务的索引，方便快速聚合生成需要推送的服务纬度的数据。<br>索引信息更新完成后，会触发推送事件，此时会将所有和该服务有关的 Client 对象，通过刚产生的索引信息聚合起来，当数据聚合完成后，再从客户端链接中筛选出订阅该服务的订阅者的客户端链接，将推送数据通过该链接，推送回去。这样一次发布变更的主链路就完成了。<br>回过头看数据同步，客户端发布了服务时实际更新的对象从原来的 Service 变成 Client 对象，所以需要同步的内容也变成了 Client 对象；同时服务端间的通信方式也会换成 RPC。这里只有真正被客户端更新的 Client 对象会触发同步，如果是通过同步而更新的 Client 对象不会再次触发同步。<br>最后看 Metadata，Metadata 是从 1.X 版本中的 Service 对象和 Instance 对象中分离出来的一些属性：比如服务的元数据 label 标签，实例的上下线状态、权重和元数据 label 标签等。这些元数据可以被 openAPI 单独修改，在聚合数据时生效。之所以将元数据拆分出来，区别于基础数据，原因是基础数据比如：ip 端口，服务名等一经发布不应该被修改，而且应当以发布时的信息为准；但其他的原数据，比如上下线状态和权重，通常是在运行过程中动态调节的，因此拆分开之后，分为两条不同的处理工作流应该更加合理。</p>
<h3 id="Nacos-2-0-架构的优缺点"><a href="#Nacos-2-0-架构的优缺点" class="headerlink" title="Nacos 2.0 架构的优缺点"></a>Nacos 2.0 架构的优缺点</h3><p>前面简要介绍了 Nacos 2.0 的架构和新模型的工作方式，接下来我们分析一下这样的改动有哪些优缺点。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187199068-efc7d1d5-451c-4d57-9f70-9f5283ac1bcc.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=413&id=uabd7a682&margin=%5Bobject%20Object%5D&name=image.png&originHeight=826&originWidth=1106&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=694419&status=done&style=none&taskId=u86a6c9d4-1942-4731-98e1-9edcd21fbeb&title=&width=553" alt="image.png" width="553"></p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>客户端不再需要定时发送实例心跳，只需要有一个维持连接可用 keepalive 消息即可。重复 TPS 可以大幅降低。</li>
<li>TCP 连接断开可以被快速感知到，提升反应速度。</li>
<li>长连接的流式推送，比 UDP 更加可靠；nio 的机制具有更高的吞吐量，而且由于可靠推送，可以加长客户端用于对账服务列表的时间，甚至删除相关的请求。重复的无效 QPS 可以大幅降低。</li>
<li>长连接避免频繁连接开销，可以大幅缓解 TIME_ WAIT 问题。</li>
<li>真实的长连接，解决配置模块 GC 问题。</li>
<li>更细粒度的同步内容，减少服务节点间的通信压力。</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>没有银弹的方案，新架构也会引入一些新问题：</li>
<li>内部结构复杂度上升，管理连接状态，连接的负载均衡需要管理。</li>
<li>数据又原来的无状态，变为与连接绑定的有状态数据，流程链路更长。</li>
<li>RPC 协议的观测性不如 HTTP。即使 gRPC 基于 HTTP2.0Stream 实现，仍然不如直接使用 HTTP 协议来的直观。</li>
</ul>
<h2 id="Nacos-2-X-规划"><a href="#Nacos-2-X-规划" class="headerlink" title="Nacos 2.X 规划"></a>Nacos 2.X 规划</h2><p>接下来简单分享下 Nacos 2.X 的后期规划，主要分为文档、质量和 Roadmap。<br>在文档和质量方面，Nacos 1.X 都做的不是很好。文档内容较少，仅有简单使用文档；和版本有一定脱节，更新不及时；没有对技术内容的说明，参与贡献难度高。代码质量及测试质量也不是很高，虽然已经使用 checkstyle 进行了 codeStyle 的校验以及开启了社区协作 review。但是这还远远不够。Nacos 2.X 将会逐步更新、细化官网使用文档；通过电子书对技术细节进行解析；通过 Github 展示技术方案，促进讨论及贡献；并且对代码进行大量重构及 UT 和 IT 的治理工作，在未来将 Benchmark 也会开源出来，方便给开源用户进行压测。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/104130/1647187260940-7947ba57-e15b-4bff-b40a-53f5636d684a.png#clientId=u3381db7b-bd5f-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=413&id=ue56cd15f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=826&originWidth=1800&originalType=binary%E2%88%B6=1&rotation=0&showTitle=false&size=490103&status=done&style=none&taskId=u11aa0ade-115c-4b4b-afda-9ff959e6697&title=&width=900" alt="image.png" width="900">而 RoadMap 方面，Nacos 2.X 会对项目做大幅度的重构，完成初步插件化，并对刚才 2.0 架构的一些缺点，如负载均衡，可观测性进行提升。</p>

</div>
<footer class="post-meta">
    <span class="post-tag">
        
        <span class="post-meta-item-icon">
                <i class="fa far fa-folder-open"></i>
            </span>
        
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                <a href="/tags/Nacos/" itemprop="url" rel="index">
                  <span itemprop="name">Nacos</span>
                </a>
            </span>
        
        
    </span>
</footer>

<div class="author">
    <!--个人信息-->
    
    <img class="author-image qrcode" itemprop="image"
         src="https://cdn.alicharles.com/static/images/mp_qrcode.jpg"
         alt="https://cdn.alicharles.com/static/images/mp_qrcode.jpg"/>
    
</div>


<div class="post-nav">
    <div class="post-nav-next post-nav-item">
        
        <a href="/article/nacos/nacos-config/" rel="next" title="Nacos2动态配置">
            <i class="fa far fa-chevron-left"></i> Nacos2动态配置
        </a>
        
    </div>
    <span class="post-nav-divider"></span>
    <div class="post-nav-prev post-nav-item">
        
        <a href="/article/design-pattern/go-design-pattern/" rel="prev" title="设计模式与GO">
            设计模式与GO <i class="fa far fa-chevron-right"></i>
        </a>
        
    </div>
</div>

        </section>
    </div>
    <div id="post-toc" class="post-toc">
        <div class="post-toc-title">文章目录</div>
        <div class="post-toc-content">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos-1-X-%E6%9E%B6%E6%9E%84%E5%8F%8A%E9%97%AE%E9%A2%98"><span class="toc-text">Nacos 1.X 架构及问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-1-X-%E6%9E%B6%E6%9E%84%E5%B1%82%E6%AC%A1"><span class="toc-text">Nacos 1.X 架构层次</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-1-X-%E6%9E%B6%E6%9E%84%E4%B8%8B%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9E%8B"><span class="toc-text">Nacos 1.X 架构下的服务模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-X-%E6%9E%B6%E6%9E%84%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">1.X 架构存在的问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos-2-0-%E6%9E%B6%E6%9E%84%E5%8F%8A%E6%96%B0%E6%A8%A1%E5%9E%8B"><span class="toc-text">Nacos 2.0 架构及新模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-2-0-%E6%9E%B6%E6%9E%84%E5%B1%82%E6%AC%A1"><span class="toc-text">Nacos 2.0 架构层次</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-2-0-%E6%96%B0%E6%9C%8D%E5%8A%A1%E6%A8%A1%E5%9E%8B"><span class="toc-text">Nacos 2.0 新服务模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacos-2-0-%E6%9E%B6%E6%9E%84%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">Nacos 2.0 架构的优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-text">优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%BA%E7%82%B9"><span class="toc-text">缺点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos-2-X-%E8%A7%84%E5%88%92"><span class="toc-text">Nacos 2.X 规划</span></a></li></ol>
        </div>
    </div>
    
</div>

  <!-- footer -->
  <div class="footer">
    <div class="container justify-content-center py-4">
        Charles &copy;2022 &nbsp <a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备14035515号-1</a></span> &nbsp
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1253510913'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/z_stat.php%3Fid%3D1253510913%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
    </div>

    <!-- scrollTop -->
    <div class="go-top">
        <i class="fas fa-arrow-up"></i>
    </div>

    <!-- js -->
    <script src="//cdn.alicharles.com/static/lib/jquery/jquery.min.js"></script>
    <script src="//cdn.alicharles.com/static/lib/popper.js/popper.js"></script>
    <script src="//cdn.alicharles.com/static/lib/bootstrap/js/bootstrap.min.js"></script>
    <script src="//cdn.alicharles.com/static/lib/prism/js/prism.js"></script>
    <script src="//cdn.alicharles.com/static/js/app.js"></script>

    
</div>
</body>

</html>
